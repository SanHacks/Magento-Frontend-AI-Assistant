<?php
/**
 * @var \Gundo\ProductInfoAgent\Block\Adminhtml\Dashboard $block
 */
?>
<div class="admin__page-section">
    <div class="admin__page-section-title">
        <span class="title"><?= __('Product Info Agent Dashboard') ?></span>
        <div class="admin__page-section-title-actions">
            <button type="button" class="action-secondary" id="refresh-dashboard">
                <span><?= __('Refresh Data') ?></span>
            </button>
        </div>
    </div>
    
    <div class="admin__page-section-content">
        <!-- Key Metrics Cards -->
        <div class="dashboard-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="metric-card" style="background: #fff; padding: 20px; border: 1px solid #e3e3e3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 10px 0; color: #333; font-size: 14px; font-weight: 600;"><?= __('Total Interactions') ?></h3>
                <div style="font-size: 32px; font-weight: bold; color: #007cba;" id="total-interactions">
                    <?= $block->getTotalInteractions() ?>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    <span id="interactions-trend">+12% from last week</span>
                </div>
            </div>
            
            <div class="metric-card" style="background: #fff; padding: 20px; border: 1px solid #e3e3e3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 10px 0; color: #333; font-size: 14px; font-weight: 600;"><?= __('Voice Usage') ?></h3>
                <div style="font-size: 32px; font-weight: bold; color: #eb5202;" id="voice-usage">
                    <?= $block->getVoiceUsagePercentage() ?>%
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    <span id="voice-trend">+5% from last week</span>
                </div>
            </div>
            
            <div class="metric-card" style="background: #fff; padding: 20px; border: 1px solid #e3e3e3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 10px 0; color: #333; font-size: 14px; font-weight: 600;"><?= __('Image Processing') ?></h3>
                <div style="font-size: 32px; font-weight: bold; color: #28a745;" id="image-usage">
                    <?= $block->getImageUsageCount() ?>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    <span id="image-trend">+8% from last week</span>
                </div>
            </div>
            
            <div class="metric-card" style="background: #fff; padding: 20px; border: 1px solid #e3e3e3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 10px 0; color: #333; font-size: 14px; font-weight: 600;"><?= __('Satisfaction Rate') ?></h3>
                <div style="font-size: 32px; font-weight: bold; color: #79a22e;" id="satisfaction-rate">
                    <?= $block->getSatisfactionRate() ?>%
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    <span id="satisfaction-trend">+3% from last week</span>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="dashboard-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div class="chart-container" style="background: #fff; padding: 20px; border: 1px solid #e3e3e3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 16px; font-weight: 600;"><?= __('Daily Interactions') ?></h3>
                <canvas id="daily-interactions-chart" width="400" height="200"></canvas>
            </div>
            
            <div class="chart-container" style="background: #fff; padding: 20px; border: 1px solid #e3e3e3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 16px; font-weight: 600;"><?= __('Feature Usage') ?></h3>
                <canvas id="feature-usage-chart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Additional Charts -->
        <div class="dashboard-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div class="chart-container" style="background: #fff; padding: 20px; border: 1px solid #e3e3e3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 16px; font-weight: 600;"><?= __('Response Times') ?></h3>
                <canvas id="response-times-chart" width="400" height="200"></canvas>
            </div>
            
            <div class="chart-container" style="background: #fff; padding: 20px; border: 1px solid #e3e3e3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 16px; font-weight: 600;"><?= __('User Engagement') ?></h3>
                <canvas id="user-engagement-chart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity" style="background: #fff; padding: 20px; border: 1px solid #e3e3e3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 16px; font-weight: 600;"><?= __('Recent Activity') ?></h3>
            <div id="recent-activity-content">
                <div class="loading-spinner" style="text-align: center; padding: 20px;">
                    <div class="spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007cba; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="color: #666; margin-top: 10px;"><?= __('Loading recent activity...') ?></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
require(['jquery', 'mage/url', 'domReady!'], function($, urlBuilder) {
    'use strict';
    
    // Dashboard data management
    var dashboardData = {
        chartInstances: {},
        refreshInterval: null,
        isLoading: false
    };

    // Initialize dashboard
    function initializeDashboard() {
        loadChartLibrary();
        loadDashboardData();
        setupEventListeners();
        startAutoRefresh();
    }

    // Load Chart.js library
    function loadChartLibrary() {
        if (typeof Chart === 'undefined') {
            // Load Chart.js from CDN if not available
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
            script.onload = function() {
                console.log('Chart.js loaded successfully');
                initializeCharts();
            };
            document.head.appendChild(script);
        } else {
            initializeCharts();
        }
    }

    // Load dashboard data via AJAX
    function loadDashboardData() {
        if (dashboardData.isLoading) return;
        
        dashboardData.isLoading = true;
        
        var ajaxUrl = urlBuilder.build('productinfoagent/dashboard/data');
        
        $.ajax({
            url: ajaxUrl,
            method: 'GET',
            dataType: 'json',
            timeout: 30000,
            success: function(response) {
                if (response.success) {
                    updateDashboardMetrics(response.data);
                    updateChartData(response.data);
                    updateRecentActivity(response.data.recent_activity);
                } else {
                    console.error('Dashboard data load failed:', response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Dashboard AJAX error:', error);
                showErrorMessage('Failed to load dashboard data');
            },
            complete: function() {
                dashboardData.isLoading = false;
            }
        });
    }

    // Update dashboard metrics
    function updateDashboardMetrics(data) {
        if (data.metrics) {
            $('#total-interactions').text(data.metrics.total_interactions || 0);
            $('#voice-usage').text((data.metrics.voice_usage_percentage || 0) + '%');
            $('#image-usage').text(data.metrics.image_usage_count || 0);
            $('#satisfaction-rate').text((data.metrics.satisfaction_rate || 0) + '%');
            
            // Update trends
            $('#interactions-trend').text(data.metrics.interactions_trend || '+0%');
            $('#voice-trend').text(data.metrics.voice_trend || '+0%');
            $('#image-trend').text(data.metrics.image_trend || '+0%');
            $('#satisfaction-trend').text(data.metrics.satisfaction_trend || '+0%');
        }
    }

    // Initialize charts
    function initializeCharts() {
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js not available');
            return;
        }

        // Daily Interactions Chart
        initializeDailyInteractionsChart();
        
        // Feature Usage Chart
        initializeFeatureUsageChart();
        
        // Response Times Chart
        initializeResponseTimesChart();
        
        // User Engagement Chart
        initializeUserEngagementChart();
    }

    // Daily Interactions Chart
    function initializeDailyInteractionsChart() {
        var ctx = document.getElementById('daily-interactions-chart');
        if (!ctx) return;

        if (dashboardData.chartInstances.dailyInteractions) {
            dashboardData.chartInstances.dailyInteractions.destroy();
        }

        dashboardData.chartInstances.dailyInteractions = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: ['7 days ago', '6 days ago', '5 days ago', '4 days ago', '3 days ago', '2 days ago', 'Yesterday', 'Today'],
                datasets: [{
                    label: 'Interactions',
                    data: [12, 19, 8, 15, 22, 18, 25, 30],
                    borderColor: '#007cba',
                    backgroundColor: 'rgba(0, 124, 186, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Feature Usage Chart
    function initializeFeatureUsageChart() {
        var ctx = document.getElementById('feature-usage-chart');
        if (!ctx) return;

        if (dashboardData.chartInstances.featureUsage) {
            dashboardData.chartInstances.featureUsage.destroy();
        }

        dashboardData.chartInstances.featureUsage = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Text Chat', 'Voice Recording', 'Image Processing', 'Suggestions'],
                datasets: [{
                    data: [45, 25, 20, 10],
                    backgroundColor: ['#007cba', '#eb5202', '#28a745', '#ffc107'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    // Response Times Chart
    function initializeResponseTimesChart() {
        var ctx = document.getElementById('response-times-chart');
        if (!ctx) return;

        if (dashboardData.chartInstances.responseTimes) {
            dashboardData.chartInstances.responseTimes.destroy();
        }

        dashboardData.chartInstances.responseTimes = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['< 1s', '1-2s', '2-3s', '3-5s', '> 5s'],
                datasets: [{
                    label: 'Response Count',
                    data: [45, 35, 15, 8, 2],
                    backgroundColor: '#28a745',
                    borderColor: '#1e7e34',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // User Engagement Chart
    function initializeUserEngagementChart() {
        var ctx = document.getElementById('user-engagement-chart');
        if (!ctx) return;

        if (dashboardData.chartInstances.userEngagement) {
            dashboardData.chartInstances.userEngagement.destroy();
        }

        dashboardData.chartInstances.userEngagement = new Chart(ctx.getContext('2d'), {
            type: 'radar',
            data: {
                labels: ['New Users', 'Returning Users', 'Active Sessions', 'Avg. Session Time', 'Feature Adoption'],
                datasets: [{
                    label: 'Current Period',
                    data: [80, 65, 90, 75, 85],
                    borderColor: '#007cba',
                    backgroundColor: 'rgba(0, 124, 186, 0.2)',
                    pointBackgroundColor: '#007cba',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#007cba'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    r: {
                        angleLines: {
                            display: true
                        },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                }
            }
        });
    }

    // Update chart data
    function updateChartData(data) {
        if (data.charts) {
            // Update daily interactions
            if (data.charts.daily_interactions && dashboardData.chartInstances.dailyInteractions) {
                dashboardData.chartInstances.dailyInteractions.data.datasets[0].data = data.charts.daily_interactions;
                dashboardData.chartInstances.dailyInteractions.update();
            }

            // Update feature usage
            if (data.charts.feature_usage && dashboardData.chartInstances.featureUsage) {
                dashboardData.chartInstances.featureUsage.data.datasets[0].data = data.charts.feature_usage;
                dashboardData.chartInstances.featureUsage.update();
            }

            // Update response times
            if (data.charts.response_times && dashboardData.chartInstances.responseTimes) {
                dashboardData.chartInstances.responseTimes.data.datasets[0].data = data.charts.response_times;
                dashboardData.chartInstances.responseTimes.update();
            }

            // Update user engagement
            if (data.charts.user_engagement && dashboardData.chartInstances.userEngagement) {
                dashboardData.chartInstances.userEngagement.data.datasets[0].data = data.charts.user_engagement;
                dashboardData.chartInstances.userEngagement.update();
            }
        }
    }

    // Update recent activity
    function updateRecentActivity(activities) {
        var content = $('#recent-activity-content');
        if (!activities || activities.length === 0) {
            content.html('<p style="color: #666; text-align: center; padding: 20px;">No recent activity found.</p>');
            return;
        }

        var html = '<div class="activity-list">';
        activities.forEach(function(activity) {
            html += '<div class="activity-item" style="padding: 10px 0; border-bottom: 1px solid #f0f0f0;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
            html += '<div>';
            html += '<strong>' + activity.type + '</strong>';
            html += '<div style="color: #666; font-size: 12px;">' + activity.description + '</div>';
            html += '</div>';
            html += '<div style="color: #999; font-size: 12px;">' + activity.time + '</div>';
            html += '</div>';
            html += '</div>';
        });
        html += '</div>';
        
        content.html(html);
    }

    // Setup event listeners
    function setupEventListeners() {
        $('#refresh-dashboard').on('click', function() {
            loadDashboardData();
        });
    }

    // Start auto-refresh
    function startAutoRefresh() {
        dashboardData.refreshInterval = setInterval(function() {
            loadDashboardData();
        }, 300000); // Refresh every 5 minutes
    }

    // Show error message
    function showErrorMessage(message) {
        // You can implement a proper notification system here
        console.error(message);
    }

    // Initialize dashboard when DOM is ready
    initializeDashboard();
});
</script>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.dashboard-metrics .metric-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.dashboard-metrics .metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.dashboard-charts .chart-container {
    transition: all 0.3s ease;
    position: relative;
}

.dashboard-charts .chart-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.recent-activity {
    transition: all 0.3s ease;
}

.recent-activity:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.activity-item:last-child {
    border-bottom: none !important;
}

.admin__page-section-title-actions {
    display: flex;
    gap: 10px;
}

.action-secondary {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.action-secondary:hover {
    background: #007cba;
    color: white;
    border-color: #007cba;
}

@media (max-width: 768px) {
    .dashboard-metrics {
        grid-template-columns: 1fr 1fr !important;
    }
    
    .dashboard-charts {
        grid-template-columns: 1fr !important;
    }
}

@media (max-width: 480px) {
    .dashboard-metrics {
        grid-template-columns: 1fr !important;
    }
}
</style> 